// Generated by CoffeeScript 1.10.0
var CompressImg, ConvertTemplate, Home, compress, convert, formidable, fs, path, util, uuid, uuidRandon;

CompressImg = require('../classes/compress_img');

ConvertTemplate = require('../classes/convert_template');

fs = require('fs');

formidable = require('formidable');

path = require('path');

util = require('util');

uuid = require('node-uuid');

compress = new CompressImg;

convert = new ConvertTemplate;

uuidRandon = uuid.v1();

Home = (function() {
  function Home() {
    this.compress = new CompressImg;
  }

  Home.prototype.post = function(req, res) {
    var fields, form;
    fields = [];
    form = new formidable.IncomingForm();
    form.multiples = true;
    console.log(uuidRandon);
    form.uploadDir = path.join('./', '/uploads');
    form.on('fileBegin', function(name, file) {
      file.path = './uploads/' + file.name;
      return console.log('Uploaded ' + file.name);
    });
    form.on('file', function(name, file) {
      fs.rename(file.path, path.join(form.uploadDir, file.name));
    });
    form.on('field', function(field, value) {
      fields[field] = value;
    });
    form.on('error', function(err) {
      console.log('An error has occured: \n' + err);
    });
    form.on('end', function() {
      res.write('received the data:\n\n');
      res.end(util.inspect({
        fields: fields
      }));
      console.log(fields.fields);
      console.log(fields.typeFiles);
      if (fields.typeFiles === 'text/html') {
        convert.startConvert(fields.fields);
        console.log('chama conversor template');
      }
    });
    form.parse(req);
  };

  return Home;

})();

module.exports = Home;
